[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]

[include mainsail.cfg]
[include macros.cfg]
[include sound.cfg]
[include shell_command.cfg]

[save_variables]
filename: /home/admin/printer_CC_data/config/variables.cfg

[exclude_object]
[force_move]
enable_force_move: True


#####################################################################
# MCUs & Printer Settings
#####################################################################

[mcu]
canbus_uuid: 6709da268a59

[mcu toolhead]
canbus_uuid: b864fcd507c5

[printer]
kinematics: corexy
max_velocity: 400           # Was set at 600
max_accel: 83000           # was at 58000
minimum_cruise_ratio: 0.5    # Restored for better quality in real-world prints
square_corner_velocity: 10.0 # Lowered from 25 for better corner sharpess/quality
max_z_velocity: 60    
max_z_accel: 1000


#####################################################################
# ALESI MOD CENTAURI - PHASE 3 (2804AH + 52V OPTIMIZED)
#####################################################################

[stepper_x]
step_pin: PF13        
dir_pin: PF12         
enable_pin: !PF14    
rotation_distance: 40
microsteps: 16             
endstop_pin: tmc5160_stepper_x:virtual_endstop
homing_retract_dist: 0
position_endstop: 255         
position_max: 255
homing_speed: 80          
position_min: 0        
step_pulse_duration: 0.000001  # Reset to 1us to avoid MCU "Timer too close" errors

[tmc5160 stepper_x]
cs_pin: PD11
spi_bus: spi1
diag1_pin: ^!PG9           
driver_SGT: 1               
run_current: 2.4            # 2804AH motors can handle this with your 120mm fan
sense_resistor: 0.075
stealthchop_threshold: 0  
interpolate: False           
spi_speed: 1000000           # Lowered for better signal integrity over SPI
# --- PHASE 3 TUNING FOR 2804AH INDUCTANCE ---
driver_TBL: 1               
driver_TOFF: 3              
driver_HSTRT: 7              
driver_HEND: 4              
driver_TPFD: 0

[stepper_y]
step_pin: PG0       
dir_pin: PG1          
enable_pin: !PF15    
rotation_distance: 40
microsteps: 16
endstop_pin: tmc5160_stepper_y:virtual_endstop
homing_retract_dist: 0
position_endstop: 0         
position_max: 267
homing_speed: 80
homing_positive_dir: false
position_min: 0 
step_pulse_duration: 0.000001

[tmc5160 stepper_y]
cs_pin: PC4
spi_bus: spi1
diag1_pin: ^!PG6           
driver_SGT: 1              
run_current: 2.4            
sense_resistor: 0.075
stealthchop_threshold: 0
interpolate: False           
spi_speed: 1000000           
# --- PHASE 3 TUNING FOR 2804AH INDUCTANCE ---
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 7
driver_HEND: 4
driver_TPFD: 0


#####################################################################
# Z Stepper & Homing Logic (Optical + Load Cell)
#####################################################################

[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5           
rotation_distance: 8
microsteps: 16
endstop_pin: ~PC5          # Optical Sensor for initial G28
#position_endstop: 0 
position_max: 256
position_min: -10
homing_retract_dist: 2    # Distance it moves up
homing_retract_speed: 10  # <--- CHANGE THIS (Speed in mm/s for moving UP)
homing_speed: 30          # Speed for moving DOWN to home
second_homing_speed: 3.0   # <--- SET THIS for a slow second touch


[tmc2209 stepper_z]
uart_pin: PC6
run_current: 0.8

#####################################################################

#####################################################################
# AMS FEEDER STEPPER DEFINITIONS (2026 FULL 5-SLOT SYNC MODE)
#####################################################################

#[duplicate_pin_override]
#pins: PG13 

# Slot 1
#[extruder_stepper ams_feeder_1]
#extruder: extruder
#step_pin: PG4
#dir_pin: !PC1
#enable_pin: !PA2
#rotation_distance: 22.68
#microsteps: 16

#[tmc2209 extruder_stepper ams_feeder_1]
#uart_pin: PC7
#run_current: 0.8

# Slot 2
#[extruder_stepper ams_feeder_2]
#extruder: extruder
#step_pin: PF9
#dir_pin: !PF10
#enable_pin: !PG2
#rotation_distance: 22.68
#microsteps: 16

#[tmc2209 extruder_stepper ams_feeder_2]
#uart_pin: PF2
#run_current: 0.8

# Slot 3
#[extruder_stepper ams_feeder_3]
#extruder: extruder
#step_pin: PC13
#dir_pin: !PF0
#enable_pin: !PF1
#rotation_distance: 22.68
#microsteps: 16

#[tmc2209 extruder_stepper ams_feeder_3]
#uart_pin: PE4
#run_current: 0.8

# Slot 4
#[extruder_stepper ams_feeder_4]
#extruder: extruder
#step_pin: PE2
#dir_pin: !PE3
#enable_pin: !PD4
#rotation_distance: 22.68
#microsteps: 16

#[tmc2209 extruder_stepper ams_feeder_4]
#uart_pin: PE1
#run_current: 0.8

# Slot 5
#[extruder_stepper ams_feeder_5]
#extruder: extruder
#step_pin: PE6
#dir_pin: !PA14
#enable_pin: !PE0
#rotation_distance: 22.68
#microsteps: 16

#[tmc2209 extruder_stepper ams_feeder_5]
#uart_pin: PD3
#run_current: 0.8

#####################################################################
# FILAMENT BUFFER SENSORS (Logic Fixed)
#####################################################################

#[filament_switch_sensor buffer_low]
#pause_on_runout: False
#switch_pin: ^!PG12  

#[filament_switch_sensor buffer_high]
#pause_on_runout: False
#switch_pin: ^!PG13  


#####################################################################
# ADS1220 LOAD CELL PROBE - MANUAL CALIBRATION APPLIED
#####################################################################

[load_cell_probe]
sensor_type: ads1220
cs_pin: PA15
spi_software_sclk_pin: PB3
spi_software_mosi_pin: PB5
spi_software_miso_pin: PB4
spi_speed: 2000000            
data_ready_pin: PB6
gain: 128
sample_rate: 2000       
tare_time: 0.1

# Remove settling_time: 1.5 <--- THIS CAUSES THE ERROR
# Ensure the rest of your 4-section filter is there:
drift_filter_cutoff_frequency: 0.1
drift_filter_delay: 3
notch_filter_frequencies: 60
notch_filter_quality: 2
buzz_filter_cutoff_frequency: 100
buzz_filter_delay: 1


# --------------------------------------------------------

# Your calibrated values (Keep these)
trigger_force: 250
force_safety_limit: 5000
#counts_per_gram: 17.745
#reference_tare_counts: 480610

# Dynamics
speed: 7               # Probing descent speed (5-10 is good)
lift_speed: 15          # Speed for the "up" move
sample_retract_dist: 2.0   # Change from 5 to 2
z_offset: 0.0             # Keep at 0.0 for nozzle probe
samples_tolerance: 0.05    # Optional: ensure accuracy between probes
samples_tolerance_retries: 3
samples: 2

#######################################

#####################################################################
# EBB36 ADXL345 ACCELEROMETER (Using 'toolhead' MCU)
#####################################################################

[adxl345]
cs_pin: toolhead: PB12
spi_software_sclk_pin: toolhead: PB10
spi_software_mosi_pin: toolhead: PB11
spi_software_miso_pin: toolhead: PB2
# Adjust axes_map based on how the EBB36 is mounted
# Standard mount is usually x,y,z
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345
probe_points:
    128, 128, 20  # Center of your 256x256 bed

#####################################################################

[bed_mesh]
speed: 100
horizontal_move_z: 2
mesh_min: 20, 20
mesh_max: 236, 236
probe_count: 11, 11
algorithm: bicubic
fade_start: 1.0
fade_end: 10.0

#####################################################################
# Extruder & Toolhead (EBB36)
#####################################################################

[extruder]
step_pin: toolhead:PD0
dir_pin: toolhead:PD1
enable_pin: !toolhead:PD2
rotation_distance: 28.8
full_steps_per_rotation: 200
gear_ratio: 52:10
microsteps: 32
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: toolhead:PB13 
sensor_type: Generic 3950
sensor_pin: toolhead:PA3   
min_temp: 0
max_temp: 331              
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
max_extrude_cross_section: 5
pressure_advance: 0.04
max_extrude_only_distance: 100.0

[tmc2209 extruder]
uart_pin: toolhead:PA15
run_current: 0.650
stealthchop_threshold: 0

#####################################################################
# Heater Bed (SSR on Fan 3)
#####################################################################

[heater_bed]
heater_pin: PD13        
sensor_pin: PF3         
sensor_type: Generic 3950
min_temp: 0
max_temp: 125.1          # Hardware-level emergency shutdown
#control: watermark      
max_power: 1.0
pwm_cycle_time: 0.100

[verify_heater heater_bed]
max_error: 120
check_gain_time: 60
hysteresis: 5            # Range allowed before an error is counted

[gcode_macro SET_HEATER_TEMPERATURE]
rename_existing: _SET_HEATER_TEMPERATURE_BASE
gcode:
    {% set heater = params.HEATER|default("") %}
    {% set target = params.TARGET|default(0)|float %}
    {% if heater == "heater_bed" and target > 120 %}
        { action_respond_info("Bed limit exceeded! Forcing target to 120C.") }
        {% set target = 120 %}
    {% endif %}
    _SET_HEATER_TEMPERATURE_BASE HEATER={heater} TARGET={target}

[gcode_macro M140]
rename_existing: M140.1
gcode:
    {% set s = params.S|default(0)|float %}
    {% if s > 120 %}
        {% set s = 120 %}
    {% endif %}
    M140.1 S{s}

[gcode_macro M190]
rename_existing: M190.1
gcode:
    {% set s = params.S|default(0)|float %}
    {% if s > 120 %}
        {% set s = 120 %}
    {% endif %}
    M190.1 S{s}

#####################################################################
# Fans & Thermal Monitoring
#####################################################################

[temperature_sensor chamber]
sensor_type: Generic 3950
sensor_pin: PF4      
min_temp: 0
max_temp: 100

[heater_fan hotend_fan]
pin: toolhead:PA0
heater: extruder
heater_temp: 50.0

[fan]
pin: toolhead:PA1
kick_start_time: 0.3    # Spins fan at 100% for 0.5s before dropping to setting
off_below: 0.15         # If requested speed is < 15%, turn the fan off entirely

[temperature_sensor raspberry_pi_5]
sensor_type: temperature_host
min_temp: 0
max_temp: 85  

[temperature_sensor EBB36_Temp]
sensor_type: temperature_mcu
sensor_mcu: toolhead          

[temperature_sensor octopus_pro_mcu]
sensor_type: temperature_mcu

[fan_generic Exhaust_Case_Fan]
pin: PA8                

[fan_generic AUX_BED_Fan]
pin: PE5 

#####################################################################
# STANDARD CASE LIGHTS
#####################################################################

[output_pin Case_Lights]
pin: PD12
pwm: False
value: 1


#####################################################################
# BED TRAMMING (SCREWS TILT ADJUST)
#####################################################################

[screws_tilt_adjust]
# NOTE: These coordinates must be the NOZZLE position 
# when the PROBE is directly over the screw.
screw1: 25, 25          # Front Left
screw1_name: front left screw
screw2: 25, 235         # Back Left
screw2_name: rear left screw
screw3: 235, 235        # Back Right
screw3_name: rear right screw
screw4: 235, 25         # Front Right
screw4_name: front right screw
horizontal_move_z: 10   # High lift for safety
speed: 150
# M3 screws use CW-M3, M4 screws use CW-M4
# CW = Clockwise, CCW = Counter-Clockwise
screw_thread: CW-M3     

#####################################################################
# MACROS
#####################################################################

[gcode_macro LEVEL_BED_SCREWS]
description: Runs the automated bed screw leveling tool
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}
    SCREWS_TILT_CALCULATE

# This alias prevents the "Unknown command" error if you type the wrong name
[gcode_macro SCREWS_TILT_ADJUST]
gcode:
    SCREWS_TILT_CALCULATE



#####################################################################
# INDIVIDUAL CORNER BUTTONS (BIQU STYLE)
#####################################################################

[gcode_macro GOTO_FRONT_LEFT]
description: Move nozzle to front left screw
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %} G28 {% endif %}
    G90                   # Absolute positioning
    G1 Z10 F3000          # Lift nozzle for safety
    G1 X25 Y25 F6000      # Move to screw
    G1 Z0.1 F300          # Lower to paper test height

[gcode_macro GOTO_REAR_LEFT]
description: Move nozzle to rear left screw
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %} G28 {% endif %}
    G90
    G1 Z10 F3000
    G1 X25 Y235 F6000
    G1 Z0.1 F300

[gcode_macro GOTO_REAR_RIGHT]
description: Move nozzle to rear right screw
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %} G28 {% endif %}
    G90
    G1 Z10 F3000
    G1 X235 Y235 F6000
    G1 Z0.1 F300

[gcode_macro GOTO_FRONT_RIGHT]
description: Move nozzle to front right screw
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %} G28 {% endif %}
    G90
    G1 Z10 F3000
    G1 X235 Y25 F6000
    G1 Z0.1 F300



#######################################################################
[virtual_sdcard]
path: /home/admin/printer_CC_data/gcodes

[exclude_object]  # <--- Add ONLY this line here

#####################################################################
# FILAMENT RUNOUT SENSOR (PRINTER CC)
#####################################################################

# [filament_switch_sensor filament_runout]
# pause_on_runout: False        # Set to False to let the macro handle the pause
# switch_pin: ^PG10             # Verified Printer CC runout pin (with pull-up)
# runout_gcode:
#     M117 Filament runout detected!
#     RUNOUT_ALERT_START        # Triggers your Biqu sound alert
#     PAUSE                     # Standard Klipper pause
# insert_gcode:
#     M117 Filament inserted
#     RUNOUT_ALERT_STOP         # Stops the Biqu sound alert

#####################################################################
# IDLE TIMEOUT
#####################################################################

[idle_timeout]
timeout: 36000                # 10 hours (36000 seconds)
gcode:
    M117 10 Hour Timeout: Shutting down everything
    TURN_OFF_HEATERS          # Turns off Bed and Hotend
    M84                       # Disable motors
    # Beep was removed as requested

[gcode_macro _IDLE_NOZZLE_OFF]
gcode:
    {% if printer.pause_resume.is_paused %}
        M117 Idle 10m: Turning off Hotend
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    {% endif %}

# This handles the 10 minute hotend shutdown during a pause
[delayed_gcode nozzle_timer]
gcode:
    {% if printer.pause_resume.is_paused %}
        _IDLE_NOZZLE_OFF
    {% endif %}


#######################################################################

[gcode_arcs]
resolution: 0.1

#######################################################################

[homing_override]
axes: xyz
set_position_z: 0
gcode:
    # 1. Initial Z lift
    G90               # Ensure absolute positioning
    G1 Z5 F600        # Lift Z 5mm
    
   # 2. Home Y and move to center
    G28 Y             # Home Y
    G1 Y128 F6000     # Move Y to center (128)
    M400              # WAIT for move to finish
    
   # 3. Home X and move to center
    G28 X             # Home X
    G1 X128 F6000     # Move X to center (128)
    M400              # WAIT for move to finish
    
   # 4. Final Z home at center
    G28 Z             # Home Z
    G1 Z10 F600       # Final safety lift

[include moonraker_obico_macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = 2hump_ei
#*# shaper_freq_x = 84.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 47.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 36.093
#*# pid_ki = 6.503
#*# pid_kd = 50.081
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 76.489
#*# pid_ki = 1.705
#*# pid_kd = 857.636
#*#
#*# [load_cell_probe]
#*# counts_per_gram = 28.71000
#*# reference_tare_counts = 425518
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.762500, -0.735000, -0.700000, -0.662500, -0.686250, -0.716250, -0.742500, -0.786250, -0.817500, -0.872500, -0.940000
#*# 	-0.603750, -0.536250, -0.500000, -0.471250, -0.492500, -0.512500, -0.540000, -0.541250, -0.586250, -0.632500, -0.683750
#*# 	-0.468750, -0.403750, -0.333750, -0.320000, -0.285000, -0.325000, -0.346250, -0.356250, -0.366250, -0.402500, -0.427500
#*# 	-0.356250, -0.287500, -0.223750, -0.187500, -0.175000, -0.157500, -0.150000, -0.147500, -0.160000, -0.188750, -0.240000
#*# 	-0.277500, -0.193750, -0.118750, -0.072500, -0.022500, 0.002500, -0.001250, 0.047500, 0.013750, -0.006250, -0.040000
#*# 	-0.162500, -0.123750, -0.040000, 0.032500, 0.091250, 0.121250, 0.141250, 0.188750, 0.190000, 0.181250, 0.141250
#*# 	-0.141250, -0.061250, 0.033750, 0.095000, 0.177500, 0.221250, 0.266250, 0.310000, 0.330000, 0.342500, 0.311250
#*# 	-0.128750, -0.023750, 0.061250, 0.162500, 0.238750, 0.326250, 0.391250, 0.426250, 0.451250, 0.493750, 0.467500
#*# 	-0.111250, 0.007500, 0.092500, 0.232500, 0.348750, 0.436250, 0.502500, 0.543750, 0.612500, 0.630000, 0.651250
#*# 	-0.122500, -0.013750, 0.120000, 0.263750, 0.393750, 0.473750, 0.563750, 0.633750, 0.698750, 0.736250, 0.748750
#*# 	-0.140000, -0.013750, 0.147500, 0.325000, 0.418750, 0.540000, 0.663750, 0.728750, 0.790000, 0.817500, 0.833750
#*# x_count = 11
#*# y_count = 11
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 236.0
#*# min_y = 20.0
#*# max_y = 235.99999999999997
#*#
#*# [stepper_z]
#*# position_endstop = 6.000
