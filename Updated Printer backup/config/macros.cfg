#####################################################################
#  M220 SPEED FACTOR GOVERNOR (Hard Ceiling Lock)
#####################################################################

[gcode_macro M220]
rename_existing: M220.1
gcode:
    # Capture the speed factor from the slider (default to 100)
    {% set S = params.S|default(100)|float %}
    
    # Apply the multiplier to the gcode
    M220.1 S{S}
    
    # NEW ALESI MOD HARD LIMITS: 
    # This unlocks your 600mm/s velocity and 53k Acceleration buffer.
    SET_VELOCITY_LIMIT VELOCITY=400 ACCEL=83000 SQUARE_CORNER_VELOCITY=10.0
    
    # Optional: Log the change to the console
    { action_respond_info("Alesi Mod Speed set to %s%%. Limits: 400mm/s @ 83k Accel (SCV 10)." % (S)) }

####################################################################

[gcode_macro _MMU_PRE_PURGE]
description: Happy Hare hook to move to chute
gcode:
    MOVE_TO_PURGE_AREA

[gcode_macro _MMU_POST_PURGE]
description: Happy Hare hook to wipe nozzle
gcode:
    WIPE_NOZZLE

#####################################################################

#####################################################################
#  Z-OFFSET CALIBRATION WIZARD - TEMPERATURE & LOAD CELL OPTIMIZED
#####################################################################

[gcode_macro Z_PROBE_CALIBRATE]
description: Heat, Tare, and start Manual Z-offset calibration (Paper Test)
gcode:
    # 1. Set variables with defaults
    {% set BED_TEMP = params.BED|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(220)|float %}

    M117 Heating for Calibrate: B{BED_TEMP} E{EXTRUDER_TEMP}
    
    # 2. Heat everything and wait
    M140 S{BED_TEMP}             ; Start bed heating
    M104 S{EXTRUDER_TEMP}        ; Start nozzle heating
    M190 S{BED_TEMP}             ; Wait for bed
    M109 S{EXTRUDER_TEMP}        ; Wait for nozzle

    # 3. Preparation & Tare
    # Taring right before calibration is vital for load cell accuracy
    G28                          ; Home all axes
    G1 Z5 F3000                  ; Move to safe height
    M117 Taring Load Cell...
    LOAD_CELL_TARE               ; Zero out the drift right before starting
    
    # 4. Launch Calibration Wizard
    M117 Starting Paper Test...
    PROBE_CALIBRATE

#####################################################################
#  VARIABLE TEMPERATURE BED MESH - LOAD CELL OPTIMIZED
#####################################################################

[gcode_macro SMART_BED_MESH]
description: Instant Bed Mesh with variable temperatures (No Soak)
gcode:
    # 1. Set variables with defaults
    {% set BED_TEMP = params.BED|default(110)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(250)|float %}

    M117 Heating: Bed {BED_TEMP} / Nozzle {EXTRUDER_TEMP}
    
    # 2. Heat everything and wait
    M140 S{BED_TEMP}             ; Start bed heating
    M104 S{EXTRUDER_TEMP}        ; Start nozzle heating
    M190 S{BED_TEMP}             ; Wait for bed
    M109 S{EXTRUDER_TEMP}        ; Wait for nozzle

    # 3. Preparation & Tare
    # Since we aren't soaking, the Tare is vital to clear the heat drift
    G28                          ; Home all axes
    G1 Z5 F3000                  ; Move to safe height
    M117 Taring Drift...
    LOAD_CELL_TARE               ; Zero out the drift right before starting
    
    # 4. Execute Mesh
    BED_MESH_CLEAR
    M117 Probing 2mm Mesh...
    BED_MESH_CALIBRATE
    
    # 5. Finish
    G1 Z10 F3000
    M117 Mesh Complete!

[force_move]
enable_force_move: True

[respond]

[gcode_macro TEST_SPEED]
gcode:
    # Speed (mm/s)
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Bounding inset for large pattern (mm)
    {% set bound = params.BOUND|default(20)|int %}
    # Size for small pattern box (mm)
    {% set smallpatternsize = params.SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern bounds
    {% set x_min = printer.toolhead.axis_minimum.x + bound %}
    {% set x_max = printer.toolhead.axis_maximum.x - bound %}
    {% set y_min = printer.toolhead.axis_minimum.y + bound %}
    {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern bounds (Centered at 128, 128)
    {% set x_center = 128 %}
    {% set y_center = 128 %}
    {% set x_center_min = x_center - (smallpatternsize / 2) %}
    {% set x_center_max = x_center + (smallpatternsize / 2) %}
    {% set y_center_min = y_center - (smallpatternsize / 2) %}
    {% set y_center_max = y_center + (smallpatternsize / 2) %}

    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Initial Home and Position Capture
    { action_respond_info("TEST_SPEED: Starting %d iterations at %d mm/s, %d accel" % (iterations, speed, accel)) }
    G28
    G90                             
    G1 X128 Y128 F6000              
    M400                            
    GET_POSITION                    

    # Set Test Limits
    SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}

    {% for i in range(iterations) %}
        # Large Pattern: X and Box
        G1 X{x_min} Y{y_min} F{speed*60}
        G1 X{x_max} Y{y_max} F{speed*60}
        G1 X{x_min} Y{y_min} F{speed*60}
        G1 X{x_max} Y{y_min} F{speed*60}
        G1 X{x_min} Y{y_max} F{speed*60}
        G1 X{x_max} Y{y_min} F{speed*60}
        G1 X{x_min} Y{y_min} F{speed*60}
        G1 X{x_min} Y{y_max} F{speed*60}
        G1 X{x_max} Y{y_max} F{speed*60}
        G1 X{x_max} Y{y_min} F{speed*60}
        
        # Small Pattern: Center Jitter
        G1 X{x_center_min} Y{y_center_min} F{speed*60}
        G1 X{x_center_max} Y{y_center_max} F{speed*60}
        G1 X{x_center_min} Y{y_center_min} F{speed*60}
        G1 X{x_center_max} Y{y_center_min} F{speed*60}
        G1 X{x_center_min} Y{y_center_max} F{speed*60}
        G1 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    # Restore Default Limits
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} 

    # Final Verification Home
    G28
    G90
    G1 X128 Y128 F6000
    M400
    GET_POSITION 

    RESTORE_GCODE_STATE NAME=TEST_SPEED


##################

[gcode_macro M106]
rename_existing: M106.1
gcode:
    {% set s = params.S|default(0)|int %}
    {% if s > 0 and s < 39 %}
        # Force 1-15% (S1 to S38) up to 15% (S39)
        M106.1 S39
    {% else %}
        # Allow 0 and 16-100% to pass through
        M106.1 S{s}
    {% endif %}

##################

[gcode_macro INPUT_SHAPER_CALIBRATION]
description: Full Input Shaper Calibration for CoreXY

gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %}
    G28 ; Home axes if not already homed
  {% endif %}
  G90 ; Absolute positioning
  G0 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_maximum.y / 2} Z20 F6000 ; Center toolhead
  SHAPER_CALIBRATE ; Run the calibration for both axes
  SAVE_CONFIG ; Automatically save results and restart


[gcode_macro AI_OFF]
description: Disable Obico Spaghetti Detection
gcode:
    {action_call_remote_method("set_obico_config", enabled=False)}
    M117 AI Monitoring Disabled

[gcode_macro AI_ON]
description: Enable Obico Spaghetti Detection
gcode:
    {action_call_remote_method("set_obico_config", enabled=True)}
    M117 AI Monitoring Enabled


[gcode_macro OBICO_PAUSE]
gcode:
    {action_respond_info("Obico: AI Monitoring Paused")}
    # This sends a status update that the local server interprets

[gcode_macro OBICO_RESUME]
gcode:
    {action_respond_info("Obico: AI Monitoring Resumed")}


#####################################################################
# START / END / CANCEL PRINT (PRINTER CC)
#####################################################################

[gcode_macro _START_PRINT]
description: Home, Mesh, THEN Load and Purge
gcode:
    RUN_SHELL_COMMAND CMD=play_print
    # 0. Get parameters from slicer (Added INITIAL_TOOL)
    {% set T_BED = params.TEMP_BED|default(60)|int %}
    {% set T_EXTRUDER = params.TEMP_EXTRUDER|default(200)|float %}
    {% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
    
    # 1. MMU Setup & Safety - Pass the initial tool here
    MMU_START_SETUP INITIAL_TOOL={INITIAL_TOOL}
    MMU_START_CHECK
    
    M117 Heating...
    M190 S{T_BED}
    M109 S{T_EXTRUDER}

    # 2. Home and Clean for Mesh
    G28                         
    MOVE_TO_PURGE_AREA          
    WIPE_NOZZLE                 
    
    # 3. Bed Mesh
    G1 Z5 F600                  
    M118 Taring Cell...         
    LOAD_CELL_TARE
    BED_MESH_CALIBRATE ADAPTIVE=1 ADAPTIVE_MARGIN=10 

    # 4. Move to Chute for Filament Loading
    MOVE_TO_PURGE_AREA          

    # 5. Load and Big Purge (Uses the tool passed from slicer)
    MMU_CALC_PURGE_VOLUMES MIN=200 MAX=210
    MMU_START_LOAD_INITIAL_TOOL 

    # 6. Final Clean up
    WIPE_NOZZLE                 
    G1 Y128 F6000 

    RESPOND MSG="Stabilizing 15s..."
    G4 P15000
    
    # 7. Final Prime and Print
    LINE_PURGE
    M117 Printing...

# ##########################################################################
# END PRINT MACRO
# ##########################################################################

[gcode_macro _END_PRINT_SOUND]
gcode:
    RUN_SHELL_COMMAND CMD=play_done

[gcode_macro _END_PRINT]
description: Actions to take when a print is finished
gcode:
    # 1. Sound Notification
    _END_PRINT_SOUND

    # 2. Calculate and Execute Immediate Safety Z-Lift
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set current_z = printer.toolhead.position.z|float %}
    {% set actual_lift_amount = [20.0, max_z - current_z]|min %}
    {% set actual_lift_amount = [5.0, actual_lift_amount]|max %}
  
    G91                             ; Set to Relative positioning
    G1 Z5 F6000                     ; Quick initial hop
    G0 Z{actual_lift_amount} F1200  ; Controlled lift to safe height
    G90                             ; Return to Absolute positioning

    # 3. Unload Filament (Triggers MOVE_TO_PURGE_AREA automatically)
    RESPOND MSG="Unloading filament..."
    MMU_UNLOAD

    # 4. Shutdown and Cooldown
    TURN_OFF_HEATERS                ; Turn off hotend and bed
    M107                            ; Turn off part cooling fan
    M84                             ; Disable steppers
    
    RESPOND MSG="Print Finished"
    M117 Print done

[gcode_macro CANCEL_PRINT]
description: Cancel, Drop Z, and Restart
rename_existing: BASE_CANCEL_PRINT
gcode:
    RUN_SHELL_COMMAND CMD=play_cancel
    TURN_OFF_HEATERS
    M107
    G91
    G1 Z10 F3000                  
    G90
    M400                          
    BASE_CANCEL_PRINT
    
    #RESPOND MSG="Restarting firmware..."
    #G4 P2000                      
    #FIRMWARE_RESTART

#####################################################################
# FILAMENT & UTILITY (HIDDEN FROM DASHBOARD)
#####################################################################

[pause_resume]
# This enables the pause/resume engine in Klipper

[gcode_macro _RUNOUT_ALERT_START]
gcode:
    RUN_SHELL_COMMAND CMD=play_runout

[gcode_macro _RUNOUT_ALERT_STOP]
gcode:
    M117 Alert Cleared

[gcode_macro PAUSE]
description: Pause the print and save state safely
rename_existing: BASE_PAUSE
gcode:
    # Only perform the move if we are not already paused
    {% if printer.pause_resume.is_paused == False %}
        SAVE_GCODE_STATE NAME=PAUSE_state
        BASE_PAUSE
        G91
        G1 Z10 F600 ; Move bed down 10mm once
        G90
        MOVE_TO_PURGE_AREA
    {% else %}
        RESPOND MSG="Printer already paused, skipping move."
    {% endif %}


[gcode_macro RESUME]
description: Smart Resume - Purge if cold, but ALWAYS wipe
rename_existing: BASE_RESUME
gcode:
    # 1. Determine target temperature
    {% set target_temp = printer.mmu.last_extruder_temp|default(220) %}
    
    # 2. Temperature and Purge Logic
    {% if printer.extruder.temperature < (target_temp - 5) %}
        M117 Nozzle cold: Reheating and 20mm Purge...
        M109 S{target_temp}         ; Wait for heat
        G92 E0
        G1 E20 F300                 ; Recovery Purge
        G92 E0
    {% else %}
        M117 Nozzle hot: 2mm Quick Prime...
        G92 E0
        G1 E2 F300                  ; Tiny prime to ensure pressure
        G92 E0
    {% endif %}

    # 3. Always Clean Nozzle before returning to print
    WIPE_NOZZLE                     

    # 4. Restore position and continue
    M117 Resuming Print
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED=100
    BASE_RESUME

[gcode_macro M600]
rename_existing: M600.1
gcode:
    _M600

[gcode_macro _M600]
description: Hidden filament change macro
gcode:
    # Now calls PAUSE which saves the correct PAUSE_state
    PAUSE                              
    M83                                
    G1 E-50 F1000                      

[gcode_macro _M601] 
gcode: PAUSE

[gcode_macro _M205]
gcode: M105

[gcode_macro _M729]
gcode: WIPE_NOZZLE

#####################################################################
# VISIBLE UTILITY MACROS
#####################################################################

[gcode_macro MOVE_TO_PURGE_AREA]
description: Move toolhead to custom purge location with 5mm safety lift
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    G91             ; Set to Relative positioning
    G1 Z5 F600      ; Lift exactly 5mm from current height
    G90             ; Return to Absolute positioning
    G0 X205 Y250 F6000 ; Travel to purge station entry
    G0 Y266 F3000   ; Move into the wiper


[gcode_macro WIPE_NOZZLE]
description: Wipe nozzle command
gcode:
    MOVE_TO_PURGE_AREA  # Ensure we are at the purge station first
    G90                 # Absolute positioning
    G1 X190 F6000       # Move to the start of the wiper (Y is already 266)
    # The scrubbing moves:
    G1 X170 F3000
    G1 X190
    G1 X170
    G1 X190
    G1 X170
    G1 X190
    G1 X170
    G1 X190
    G1 X170
    G1 X190


#####################################################################
# REQUIRED SUPPORT SECTIONS
#####################################################################

[pause_resume]
recover_velocity: 100.0

[display_status]

[gcode_macro LOAD_FILAMENT]
gcode:
    {% set HOTEND_TEMP = params.HOTEND_TEMP|default(240)|float %}
    G28                         # Changed from _CG28 to G28
    M104 S{HOTEND_TEMP}
    M109 S{HOTEND_TEMP}
    G91
    G1 E50 F300
    G1 E40 F150
    G4 P5000
    G90
    M104 S0
    WIPE_NOZZLE                 # Ensure this macro also exists in your config!

[gcode_macro CUT_FILAMENT]
description: Cut at X255, move to chute, flush 40mm at 5mm/s, and retract
gcode:
    SAVE_GCODE_STATE NAME=cut_state
    
    # --- SPEED PROTECTION ---
    # Store current factor and force to 100% for the mechanical cut moves
    {% set speed_factor = printer.gcode_move.speed_factor %}
    M220 S100                        
    
    G90                              ; Absolute positioning
    
    # 1. THE PHYSICAL CUT
    M117 Cutting...
    G0 X255 Y128 F3600               ; Approach block
    G0 Y8 F1200                      ; Slow press
    G0 Y5 F100                       ; Safe mechanical cut speed (1.6mm/s)
    M400                             ; Wait for moves to finish
    G4 P1000                         ; Separation dwell
    G0 Y30 F3600                     ; Back away from block
    
    # 2. THE MOVE: Head to the Purge Chute
    M117 Moving to Chute...
    MOVE_TO_PURGE_AREA               
    
    # 3. THE PUSH-FLUSH (5mm/s safe speed)
    M117 Flushing Remnant...
    M83                              ; Relative extrusion
    G1 E5 F300                      ; 40mm at 5mm/s (F300 = 5mm/s)
    M400
    
    # 4. THE RETRACT (MMU hand-off)
    M117 Retracting...
    G1 E-15 F3000                    ; Fast 15mm retract to clear gears
    M400                             
    
    # --- RESTORE SPEED & STATE ---
    M220 S{speed_factor * 100}       ; Return to your print speed (160%+)
    RESTORE_GCODE_STATE NAME=cut_state
    
[gcode_macro UNLOAD_FILAMENT]
gcode:
    M104 S250 ; Heat up
    M109 S250 ; Wait for temp
    M83       ; Set ONLY the extruder to relative mode (Fixes movement)
    G1 E-90 F300 ; Retract filament
    M82       ; Put extruder back in absolute mode


#####################################################################
# CAMERA CONTROLS (PERSISTENT - CC PROFILE)
#####################################################################

[gcode_macro SET_CAMERA_LIGHT]
description: Set camera brightness and save it (CC Instance)
gcode:
    {% set light = params.VALUE|default(150)|int %}
    RUN_SHELL_COMMAND CMD=set_cam_light PARAMS={light}
    # Writes to /home/admin/printer_CC_data/config/variables.cfg
    SAVE_VARIABLE VARIABLE=cam_light_val VALUE={light}

[delayed_gcode LOAD_CAM_SETTINGS_AT_BOOT]
initial_duration: 5.0
gcode:
    # Reads from /home/admin/printer_CC_data/config/variables.cfg
    {% set saved_light = printer.save_variables.variables.cam_light_val|default(150)|int %}
    SET_CAMERA_LIGHT VALUE={saved_light}

#######################################################################


[gcode_macro PROBE_BED]
gcode:
    G28                         # Home first
    G1 Z5 F600                  # Move to a safe height
    M118 Stabilizing...         # Status message
    G4 P1500                    # <-- This is your 1.5s Settling Time
    LOAD_CELL_TARE
    BED_MESH_CALIBRATE ADAPTIVE=1 ADAPTIVE_MARGIN=10        

[gcode_macro LINE_PURGE]
gcode:
    {% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
    {% set x_min = all_points | map(attribute=0) | min | default(10) %}
    {% set y_min = all_points | map(attribute=1) | min | default(10) %}
    
    {% set x_start = [x_min - 5, 2] | max %} # 5mm left of part, but stay on bed
    {% set y_start = [y_min, 2] | max %}

    G90
    G92 E0
    G1 X{x_start} Y{y_start} Z0.3 F5000       # Move to start
    G1 X{x_start} Y{y_start + 40} E10 F1500   # First factory-style line (40mm long)
    G1 X{x_start + 0.4} Y{y_start + 40} F5000 # Move over slightly
    G1 X{x_start + 0.4} Y{y_start} E20 F1500  # Second factory-style line back down
    G92 E0

#########################################################################

[gcode_macro _MMU_POST_UNLOAD]
gcode:
    # 1. Break the sync link first
    MMU_SYNC_GEAR_MOTOR SYNC=0
    
    # 2. Now kill the specific motor
    {% set last_gate = printer['mmu']['last_tool'] %}
    {% if last_gate == 0 %}
        SET_STEPPER_ENABLE STEPPER=stepper_mmu_gear ENABLE=0
    {% else %}
        SET_STEPPER_ENABLE STEPPER=stepper_mmu_gear_{last_gate} ENABLE=0
    {% endif %}
    
    M118 Sync broken and Gate {last_gate} disabled.

